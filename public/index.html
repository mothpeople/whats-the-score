<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>What's the Score?</title>
    
    <!-- PWA Links -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon.png">
    <meta name="theme-color" content="#fbf7ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        /* CSS Variables & Theme Setup */
        :root {
            --bg-body: #fbf7ff; --bg-card: #ffffff; --bg-glass: rgba(251, 247, 255, 0.95);
            --text-main: #1e1b4b; --text-muted: #6b7280; --accent-primary: #c4b5fd;
            --accent-text: #7c3aed; --border-color: #ede9fe; --live-color: #8b5cf6; --nav-active: #7c3aed;
        }
        [data-theme="dark"] {
            --bg-body: #050505; --bg-card: #121212; --bg-glass: rgba(18, 18, 18, 0.9);
            --text-main: #f5f5f5; --text-muted: #a3a3a3; --accent-primary: #9f1239;
            --accent-text: #fda4af; --border-color: #262626; --live-color: #ef4444; --nav-active: #fda4af;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); transition: background-color 0.3s ease; -webkit-tap-highlight-color: transparent; }
        .font-display { font-family: 'Space Grotesk', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .theme-bg-card { background-color: var(--bg-card); }
        .card-gradient { background: var(--bg-card); border: 1px solid var(--border-color); }
        .glass { background: var(--bg-glass); backdrop-filter: blur(12px); border-top: 1px solid var(--border-color); }
        .live-indicator { background-color: var(--live-color); animation: pulse-live 2s infinite; }
        @keyframes pulse-live { 0% { box-shadow: 0 0 0 0 var(--accent-glow); } 70% { box-shadow: 0 0 0 6px rgba(0,0,0, 0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0, 0); } }
        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }
        .hidden { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden" data-theme="light">

    <!-- Header -->
    <header class="flex-none px-5 py-4 flex items-center justify-between z-20 theme-bg-card border-b border-[var(--border-color)]">
        <h1 class="text-xl font-bold tracking-tight font-display">What's the Score?</h1>
        <div class="flex items-center space-x-3">
            <a href="https://PayPal.me/sivarajpragasm" target="_blank" class="px-4 py-1.5 rounded-full bg-[#003087] text-white text-xs font-bold hover:bg-[#001c64] transition-colors shadow-sm">Donate</a>
            <button onclick="toggleTheme()" class="p-2 rounded-full border border-[var(--border-color)] bg-transparent text-[var(--text-muted)] hover:text-[var(--text-main)]">
                <i data-lucide="sun" id="themeIcon" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- VIEW: MATCHES -->
    <div id="view-matches" class="view-section active flex-1 overflow-hidden relative">
        <div class="flex-none pb-2 z-10 space-y-3 pt-3">
            <div class="px-4">
                <div class="relative group">
                    <select id="leagueSelect" class="w-full theme-bg-card text-[var(--text-main)] p-3 pl-10 rounded-xl border border-[var(--border-color)] focus:outline-none font-medium text-sm transition-all shadow-sm">
                        <option value="All">Live & Top Matches</option>
                        <option value="Premier League">English Premier League</option>
                        <option value="La Liga">Spanish La Liga</option>
                        <option value="SPL (Singapore)">SPL (Singapore)</option>
                        <option value="V.League 1">V-League 1</option>
                        <option value="J1 League">J-League 1</option>
                        <option value="Champions League">Champions League</option>
                    </select>
                    <div class="absolute left-3 top-3.5 pointer-events-none text-[var(--accent-text)]"><i data-lucide="filter" class="w-4 h-4"></i></div>
                </div>
            </div>
        </div>
        <div id="matchList" class="flex-1 overflow-y-auto p-4 space-y-3 pb-24 scroll-smooth">
            <div class="text-center mt-10 text-[var(--text-muted)]">Loading matches...</div>
        </div>
    </div>

    <!-- VIEW: FOLLOWING -->
    <div id="view-following" class="view-section flex-1 overflow-hidden relative">
        <div class="p-6 flex-1 overflow-y-auto pb-24" id="followingContent"></div>
    </div>

    <!-- VIEW: NEWS -->
    <div id="view-news" class="view-section flex-1 overflow-hidden relative">
        <div class="p-4 flex-1 overflow-y-auto pb-24 space-y-4" id="newsContent">
             <div class="text-center mt-10 text-[var(--text-muted)]">Loading headlines...</div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="flex-none glass fixed bottom-0 w-full pb-safe pt-2 z-30 mb-safe">
        <div class="flex justify-around items-center pb-4">
            <button onclick="switchTab('matches')" id="nav-matches" class="nav-item active flex flex-col items-center space-y-1 transition-all" style="color: var(--nav-active)">
                <i data-lucide="trophy" class="w-5 h-5"></i><span class="text-[10px] font-semibold">Matches</span>
            </button>
            <button onclick="switchTab('following')" id="nav-following" class="nav-item flex flex-col items-center space-y-1 text-[var(--text-muted)] hover:text-[var(--text-main)] transition-all">
                <i data-lucide="star" class="w-5 h-5"></i><span class="text-[10px] font-medium">Following</span>
            </button>
            <button onclick="switchTab('news')" id="nav-news" class="nav-item flex flex-col items-center space-y-1 text-[var(--text-muted)] hover:text-[var(--text-main)] transition-all">
                <i data-lucide="newspaper" class="w-5 h-5"></i><span class="text-[10px] font-medium">News</span>
            </button>
        </div>
    </nav>

    <script>
        // --- MOCK DATA FOR FALLBACK ---
        // This is used when the /api/matches endpoint fails (like in preview)
        const mockMatches = [
            {
                id: 101, league: "Premier League",
                home: "Man City", away: "Liverpool",
                homeLogo: "https://media.api-sports.io/football/teams/50.png", 
                awayLogo: "https://media.api-sports.io/football/teams/40.png",
                score: "2 - 2", status: "LIVE", minute: "78'",
                events: [], stats: { possession: [58, 42], shots: [14, 10], xg: [2.1, 1.8] }
            },
            {
                id: 501, league: "SPL (Singapore)",
                home: "Lion City Sailors", away: "Tampines Rovers",
                homeLogo: "https://media.api-sports.io/football/teams/4338.png", 
                awayLogo: "https://media.api-sports.io/football/teams/4339.png",
                score: "3 - 2", status: "FT", minute: "FT",
                events: [], stats: { possession: [52, 48], shots: [12, 14], xg: [2.5, 2.1] }
            },
            {
                id: 502, league: "SPL (Singapore)",
                home: "Albirex Niigata (S)", away: "Geylang Int",
                homeLogo: "https://media.api-sports.io/football/teams/4334.png", 
                awayLogo: "https://media.api-sports.io/football/teams/4335.png",
                score: "0 - 1", status: "LIVE", minute: "41'",
                events: [], stats: { possession: [40, 60], shots: [3, 8], xg: [0.2, 0.9] }
            },
            {
                id: 201, league: "V.League 1",
                home: "Cong An Ha Noi", away: "Hanoi FC",
                homeLogo: "https://media.api-sports.io/football/teams/4741.png",
                awayLogo: "https://media.api-sports.io/football/teams/4738.png",
                score: "1 - 0", status: "LIVE", minute: "32'",
                events: [], stats: { possession: [45, 55], shots: [4, 6], xg: [0.8, 0.4] }
            },
            {
                id: 401, league: "La Liga",
                home: "Real Madrid", away: "Barcelona",
                homeLogo: "https://media.api-sports.io/football/teams/541.png", 
                awayLogo: "https://media.api-sports.io/football/teams/529.png",
                score: "1 - 3", status: "FT", minute: "FT",
                events: [], stats: { possession: [45, 55], shots: [9, 15], xg: [1.2, 3.1] }
            }
        ];

        // --- 1. SERVICE WORKER REGISTRATION (PWA) ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch((err) => console.log('SW registration failed (expected in preview):', err));
        }

        // --- 2. DATA FETCHING ---
        let allMatches = []; // Global store

        async function fetchMatches(league = 'All') {
            const container = document.getElementById('matchList');
            container.innerHTML = `<div class="text-center mt-10 text-[var(--text-muted)] animate-pulse">Updating scores...</div>`;
            
            try {
                // Try to call the API
                // This will fail in preview mode because /api/ doesn't exist here
                const response = await fetch(`/api/matches?league=${encodeURIComponent(league)}`);
                
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                // Transform API Data
                if(data.length > 0) {
                    allMatches = data.map(m => ({
                        id: m.fixture.id,
                        league: m.league.name,
                        home: m.teams.home.name,
                        away: m.teams.away.name,
                        homeLogo: m.teams.home.logo,
                        awayLogo: m.teams.away.logo,
                        score: `${m.goals.home ?? 0} - ${m.goals.away ?? 0}`,
                        status: m.fixture.status.short,
                        minute: m.fixture.status.elapsed + "'",
                        date: new Date(m.fixture.date).toLocaleDateString()
                    }));
                    renderMatches(allMatches);
                } else {
                    container.innerHTML = `<div class="text-center mt-10 text-[var(--text-muted)]">No matches found today.</div>`;
                }

            } catch (error) {
                console.log("Using Mock Data (API Unavailable in Preview)");
                useMockFallback(league);
            }
        }

        async function fetchNews() {
            const container = document.getElementById('newsContent');
            try {
                const response = await fetch('/api/news');
                if (!response.ok) throw new Error("No API");
                const news = await response.json();
                
                container.innerHTML = `<h2 class="text-lg font-display font-bold px-2 mb-4">Latest Headlines</h2>`;
                news.forEach(item => {
                    container.innerHTML += createNewsItem(item.title, item.snippet, item.pubDate, item.link);
                });
            } catch (e) {
                // Fallback Mock News
                container.innerHTML = `<h2 class="text-lg font-display font-bold px-2 mb-4">Latest Headlines</h2>`;
                container.innerHTML += createNewsItem(
                    "Lion City Sailors secure crucial 3 points", 
                    "A dramatic late winner from Shawal Anuar keeps the title race alive.",
                    new Date(), 
                    "#"
                );
                container.innerHTML += createNewsItem(
                    "Haaland breaks another record", 
                    "The striker has now scored against every PL team he has faced.",
                    new Date(), 
                    "#"
                );
            }
        }
        
        function createNewsItem(title, snippet, date, link) {
            return `
                <div class="card-gradient rounded-xl p-4 shadow-sm mb-3">
                    <h3 class="font-bold text-sm mb-1 text-[var(--text-main)]">${title}</h3>
                    <p class="text-xs text-[var(--text-muted)] line-clamp-2">${snippet || ''}</p>
                    <div class="mt-3 flex justify-between items-center text-[10px] text-[var(--text-muted)]">
                        <span>${new Date(date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        <a href="${link}" target="_blank" class="font-bold text-[var(--accent-text)]">Read More</a>
                    </div>
                </div>
            `;
        }

        function renderMatches(matches) {
            const container = document.getElementById('matchList');
            container.innerHTML = '';
            
            matches.forEach(match => {
                const isLive = ['1H','2H','HT','ET','P','LIVE'].includes(match.status);
                const statusStyle = isLive ? `color: var(--live-color); font-weight: bold;` : `color: var(--text-muted);`;
                const timeOrScore = isLive 
                    ? `<span class="flex items-center gap-1.5"><span class="w-1.5 h-1.5 rounded-full live-indicator"></span> ${match.minute}</span>` 
                    : match.status;

                const div = document.createElement('div');
                div.className = 'card-gradient rounded-xl p-4 shadow-md mb-3 relative overflow-hidden flex items-center justify-between cursor-pointer';
                div.onclick = () => { /* Add modal open logic here if needed for details */ };
                div.innerHTML = `
                    <div class="flex items-center space-x-3 w-[35%]">
                        <img src="${match.homeLogo}" class="w-6 h-6 object-contain" onerror="this.src='https://via.placeholder.com/24?text=H'">
                        <span class="text-sm font-semibold truncate text-[var(--text-main)]">${match.home}</span>
                    </div>
                    <div class="flex flex-col items-center w-[30%]">
                        <span class="text-xl font-bold font-display tabular-nums text-[var(--text-main)]">${match.score}</span>
                        <span class="text-[10px] mt-1 uppercase tracking-wide" style="${statusStyle}">${timeOrScore}</span>
                    </div>
                    <div class="flex items-center justify-end space-x-3 w-[35%]">
                        <span class="text-sm font-semibold truncate text-[var(--text-main)] text-right">${match.away}</span>
                        <img src="${match.awayLogo}" class="w-6 h-6 object-contain" onerror="this.src='https://via.placeholder.com/24?text=A'">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function useMockFallback(filterLeague) {
             const container = document.getElementById('matchList');
             
             // Filter mock data
             const filtered = filterLeague === 'All' 
                ? mockMatches 
                : mockMatches.filter(m => m.league === filterLeague);
             
             renderMatches(filtered);
             
             // Add a small disclaimer
             const disclaimer = document.createElement('div');
             disclaimer.className = "text-center p-4 text-[10px] text-red-400 opacity-70";
             disclaimer.textContent = "Preview Mode: Showing Demo Data";
             container.appendChild(disclaimer);
        }

        // --- 3. INIT ---
        let isDark = false;
        function toggleTheme() {
            isDark = !isDark;
            document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
            document.querySelector('meta[name="theme-color"]').setAttribute('content', isDark ? '#050505' : '#fbf7ff');
            document.getElementById('themeIcon').setAttribute('data-lucide', isDark ? 'moon' : 'sun');
            lucide.createIcons();
        }

        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.style.color = 'var(--text-muted)';
                el.classList.remove('active');
            });
            document.getElementById(`nav-${tab}`).style.color = 'var(--nav-active)';
            
            if(tab === 'news') fetchNews();
            if(tab === 'following') renderFollowing();
        }

        // --- FOLLOWING LOGIC ---
        function renderFollowing() {
            const container = document.getElementById('followingContent');
            // Simplified for demo: Just show the first mock match as a "Followed" match
            container.innerHTML = `
                <div class="flex items-center space-x-2 mb-4">
                    <h2 class="text-lg font-bold font-display text-[var(--text-main)]">Lion City Sailors</h2>
                    <span class="text-[10px] bg-[var(--accent-text)] text-white px-2 py-0.5 rounded-full">Following</span>
                </div>
            `;
            // Reuse render logic for the specific match
            const followedMatches = mockMatches.filter(m => m.home.includes('Sailors') || m.away.includes('Sailors'));
            
            followedMatches.forEach(match => {
                // ... rendering code similar to main list ...
                 const div = document.createElement('div');
                div.className = 'card-gradient rounded-xl p-4 shadow-md mb-3 flex items-center justify-between';
                div.innerHTML = `
                    <div class="text-xs text-[var(--text-muted)] font-bold">${match.league}</div>
                    <div class="text-sm font-bold text-[var(--text-main)]">${match.score}</div>
                    <div class="text-xs text-[var(--text-muted)]">${match.home} vs ${match.away}</div>
                `;
                container.appendChild(div);
            });
        }

        // Event Listeners
        document.getElementById('leagueSelect').addEventListener('change', (e) => fetchMatches(e.target.value));

        // Start
        lucide.createIcons();
        fetchMatches('All');
    </script>
</body>
</html>